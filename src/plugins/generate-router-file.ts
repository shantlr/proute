import path from 'path';
import { RouterModules } from '../load-router/load-folder-tree/types';
import { formatImportPath } from '../utils/import-path';
import { ResolvedOptions } from './types';
import { joinPath } from '../utils/join-path';
import { pathStat } from '../utils/stats';

export const GENERATED_CODE_HEADER = `// This file is generated by proute, do not edit it manually, it will be override`;

export const generateRouterFile = async (
  routerModules: RouterModules,
  { configPath, outputRouter, outputRoutes, docs }: ResolvedOptions,
) => {
  const results = [GENERATED_CODE_HEADER, ''];

  const { dir: outputDir } = path.parse(outputRouter);

  const modules = routerModules.modules.map((module, index) => {
    // Format import route var name
    let varName = `$${index}`;

    if (module.type === 'endpoint') {
      const nameFromPath = module.expressPath
        .split('/')
        .map((part) => {
          if (part.startsWith(':')) {
            return `$${part.slice(1)}`;
          }
          return part;
        })
        .map((part) => {
          return part.replace(/[^a-zA-Z0-9]/g, '');
        })
        .join('_');
      varName = `$route_${module.method.toLowerCase()}${nameFromPath}_$${index}`;
    } else if (module.type === 'middleware') {
      varName = `$middleware_$${index}`;
    }

    return {
      id: module.id,
      module,
      importPath: formatImportPath(outputDir, module.id),
      varName,
    };
  });
  const moduleById = new Map(modules.map((module) => [module.id, module]));

  const toImportFromProute = ['isRouteEndpointModule', 'createRoute'];
  const toImportFromConf = [];

  // Generate imports
  results.push(`import { Router } from 'express';`);

  const configStat = await pathStat(configPath);
  if (configStat?.isFile()) {
    results.push(
      `import routerConfig from '${formatImportPath(path.parse(outputRoutes).dir, configPath)}'`,
    );
  }

  for (const { importPath, varName } of modules) {
    results.push(`import ${varName} from '${importPath}';`);
  }

  // Generate router
  results.push('', 'const router = Router();', '');

  // Generate router
  results.push(`//#region Routes`);
  for (const { module, varName } of modules) {
    if (module.type === 'endpoint') {
      results.push(`if (isRouteEndpointModule(${varName})) {`);
      results.push(
        `  const route = createRoute(${varName}, { middlewares: [${module.middlewaresModuleIds.map((id) => moduleById.get(id)!.varName).join(', ')}] });`,
      );
      results.push(
        `  router.${module.method}('${module.expressPath}', route.handler);`,
      );
      results.push(`}`);
    }
  }
  results.push(`//#endregion`, '');

  if (!!docs && (docs.enabled === undefined || docs.enabled)) {
    toImportFromProute.push('createOpenapiJson');
    toImportFromConf.push('RESOURCES');

    results.push('//#region Docs');
    results.push(`export const openapiJson = createOpenapiJson({`);
    results.push(`  specs: ${JSON.stringify(docs.specs ?? {})},`);
    results.push(`  resources: RESOURCES,`);
    if (configStat?.isFile()) {
      results.push(`  routerConfig: routerConfig,`);
    }
    results.push(`  endpoints: [`);
    for (const { module, varName } of modules) {
      if (module.type === 'endpoint') {
        results.push(
          `    { method: '${module.method}', path: '${module.expressPath}', module: ${varName} },`,
        );
      }
    }
    results.push(`  ],`);
    results.push(`});`);

    const jsonEndpoint =
      docs.jsonEndpoint ?? joinPath(docs.uiEndpoint, `/openapi.json`);
    results.push(`router.get('${jsonEndpoint}', (req, res) => {`);
    results.push(`  res.json(openapiJson);`);
    results.push(`});`);

    if (docs.uiEnabled === undefined || docs.uiEnabled) {
      results.push(`router.get('${docs.uiEndpoint}', (req, res) => {`);
      results.push(
        `  const jsonEndpoint = req.baseUrl ? \`\${req.baseUrl}${jsonEndpoint}\` : '${jsonEndpoint}'`,
      );
      results.push(`  res.send(\``);
      results.push(
        `<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <script type="module" src="https://unpkg.com/rapidoc/dist/rapidoc-min.js"></script>
  </head>
  <body>
    <rapi-doc spec-url = "\${jsonEndpoint}"> </rapi-doc>
  </body>
</html>` + '`',
      );
      results.push(`  );`);
      results.push('});');
    }
    results.push('//#endregion');
  }

  results.push('', `export { router };`, '');

  if (toImportFromConf.length) {
    results.splice(
      2,
      0,
      `import { ${toImportFromConf.join(', ')} } from '${formatImportPath(path.parse(outputRouter).dir, outputRoutes)}';`,
    );
  }
  if (toImportFromProute.length) {
    results.splice(
      2,
      0,
      `import { ${toImportFromProute.join(', ')} } from 'proute';`,
    );
  }

  return results.join('\n');
};
